name: Split debug files

needs:
  packages:
    - binutils
    - busybox
    - scanelf

inputs:
  packagedir:
    description: |
      The package directory to split debug files from
    default: ${{targets.destdir}}

pipeline:
  - if: ${{inputs.packagedir}} != ${{targets.contextdir}}
    runs: |
      mkdir -p "${{inputs.packagedir}}/.dbg-tmp"
      # note: the ${{targets.subpkgdir}} doesn't exist when the glob is evaluated
      scanelf -Ry "${{inputs.packagedir}}"/* | while read type src; do
        if [ "$type" != ET_DYN ]; then
          continue
        fi
        dst=${{targets.contextdir}}/usr/lib/debug/${src#"${{inputs.packagedir}}"/*/}.debug
        mkdir -p "${dst%/*}"
        ino=$(stat -c %i "$src")
        if ! [ -e "${{inputs.packagedir}}/.dbg-tmp/$ino" ]; then
          tmp=${{inputs.packagedir}}/.dbg-tmp/${src##*/}
          objcopy --only-keep-debug "$src" "$dst"
          objcopy --add-gnu-debuglink="$dst" --strip-unneeded -R .comment "$src" "$tmp"
          # preserve attributes, links
          cat "$tmp" > "$src"
          rm "$tmp"
          ln "$dst" "${{inputs.packagedir}}/.dbg-tmp/$ino"
        fi
      done
      rm -r "${{inputs.packagedir}}/.dbg-tmp"
