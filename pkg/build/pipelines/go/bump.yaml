name: Bump go deps to a certain version

needs:
  packages:
    - git

inputs:
  deps:
    description: The deps to bump, space separated
    required: true
  modroot:
    description: The root of the module
    default: .
  go-version:
    description: "The go version to set the go.mod syntax to"
    default: ""
  replaces:
    description: "The replaces to add to the go.mod file"
  tidy:
    default: true
    description: Run go mod tidy command before and after the bump
  show-diff:
    default: false
    description: Show the difference between the go.mod file before and after the bump
  tidy-compat:
    description: "Set the go version for which the tidied go.mod and go.sum files should be compatible"
    default: ""

pipeline:
  - runs: |
      # install the latest version of gobump
      go install github.com/chainguard-dev/gobump@latest

      GOPATH=$(go env GOPATH)

      cd "${{inputs.modroot}}"

      # if ${{inputs.go-version}} is not set, we use the go version of the current environment
      if [ -z "${{inputs.go-version}}" ]; then
        GO_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
      else
        GO_VERSION=${{inputs.go-version}}
      fi

      # We use the --tidy flag to run go mod tidy before and after in some cases (if old versions of go are used, we need to update the go.mod format)
      $GOPATH/bin/gobump --packages "${{inputs.deps}}" --replaces "${{inputs.replaces}}" --tidy=${{inputs.tidy}} --show-diff=${{inputs.show-diff}} --go-version=${GO_VERSION} --compat=${{inputs.tidy-compat}}